<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PRO-Vardiya v66 | Sade ve Düzenli</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1e293b; --blue: #3b82f6; --bg: #f1f5f9; --card-bg: #ffffff;
      --text: #334155; --border: #e2e8f0; --danger: #ef4444; --success: #22c55e;
      --warning: #f59e0b; --weekend-bg: #fff1f2; --mcr-color: #f59e0b;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; font-size: 12px; line-height: 1.5; }
    .app-wrapper { padding: 30px; max-width: 1600px; margin: auto; }
    
    /* Header */
    .main-header { display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 20px 30px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .btn-main-action { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 12px; }
    .btn-main-action:hover { opacity: 0.9; transform: translateY(-1px); }
    
    /* Admin Panel */
    .admin-panel { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 30px; margin-bottom: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .admin-tabs { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 1px solid var(--border); }
    .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: none; font-weight: 600; color: #94a3b8; border-bottom: 3px solid transparent; transition: 0.3s; }
    .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
    
    .admin-section { background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #f1f5f9; }
    .admin-section h4 { margin-top: 0; margin-bottom: 20px; font-size: 14px; color: var(--primary); border-left: 4px solid var(--blue); padding-left: 10px; }
    
    /* Kapasite Grid - Ferahlatılmış */
    .cap-grid-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
    .cap-row { display: grid; grid-template-columns: 200px repeat(auto-fill, minmax(140px, 1fr)); border-bottom: 1px solid var(--border); background: white; }
    .cap-header-row { background: #f8fafc; font-weight: 700; color: var(--primary); }
    .cap-cell { padding: 15px; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
    .cap-input-group { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 6px 10px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; }
    .cap-input-group label { font-size: 10px; font-weight: 700; color: #64748b; }
    .cap-input-group.weekend { border-color: #fecaca; background: #fff5f5; }
    .cap-cell input { width: 45px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px; font-weight: 600; }

    /* Ana Tablo */
    table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--card-bg); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    th { background: #f8fafc; color: var(--primary); padding: 18px 12px; font-weight: 700; border-bottom: 2px solid var(--border); text-align: center; }
    td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 12px; vertical-align: top; min-height: 120px; width: 13%; }
    .weekend-col { background-color: var(--weekend-bg) !important; }
    
    /* Birim Kartları */
    .birim-card { border-left: 4px solid var(--blue); padding: 8px 12px; margin-bottom: 8px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-top: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
    .birim-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .mcr-card { border-left-color: var(--mcr-color); }
    .izinli-card { border-left-color: var(--danger); background: #fff1f2 !important; color: var(--danger); opacity: 0.8; }
    .birim-tag { font-size: 8px; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; display: block; }
    .pers-name { font-size: 11px; font-weight: 600; color: var(--primary); }

    /* İzin Pilleri */
    .izin-gun-pill { padding: 4px 8px; background: #f1f5f9; border-radius: 6px; margin-right: 4px; font-size: 10px; cursor: pointer; font-weight: 600; display: inline-block; margin-top: 5px; }
    .izin-gun-pill.active { background: var(--danger); color: white; }

    @media print { .no-print { display: none !important; } .app-wrapper { padding: 0; } body { background: white; } }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <header class="main-header no-print">
      <div>
        <h1 style="margin:0; font-size:22px; letter-spacing:-0.5px;">PRO<span style="color:var(--blue)">Vardiya</span> <small style="font-size:12px; opacity:0.6">v66</small></h1>
        <p id="tarihAraligi" style="margin:5px 0 0 0; opacity:0.8; font-size:13px; font-weight:500;"></p>
      </div>
      <div style="display:flex; gap:10px;">
        <button onclick="haftaDegistir(-7)" class="btn-main-action" style="background:#64748b">« Geri</button>
        <button onclick="tabloyuOlustur()" class="btn-main-action" style="background:var(--success)">VARDİYA OLUŞTUR</button>
        <button onclick="window.print()" class="btn-main-action">PDF / YAZDIR</button>
        <button onclick="haftaDegistir(7)" class="btn-main-action" style="background:#64748b">İleri »</button>
        <button onclick="toggleAdminPanel()" class="btn-main-action" style="background:var(--primary); border:1px solid #475569;">YÖNETİM</button>
      </div>
    </header>

    <div id="adminPanel" class="admin-panel hidden no-print">
      <div class="admin-tabs">
        <button class="tab-btn active" onclick="tabDegistir('personel')">Personel & İzinler</button>
        <button class="tab-btn" onclick="tabDegistir('saatler')">Vardiya Saatleri</button>
        <button class="tab-btn" onclick="tabDegistir('kapasite')">Kapasite Ayarı</button>
        <button class="tab-btn" onclick="tabDegistir('sistem')">Sistem</button>
      </div>

      <div id="tab-personel" class="tab-content">
        <div class="admin-section">
          <h4>Personel Kaydı</h4>
          <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="yeniPersInp" placeholder="Personel Adı Soyadı" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border);">
            <select id="yeniPersBirimSec" style="width:200px; padding:10px; border-radius:8px; border:1px solid var(--border);"></select>
            <button onclick="personelEkle()" class="btn-main-action" style="background:var(--success)">EKLE</button>
          </div>
          <div id="persListesiAdmin"></div>
        </div>
      </div>

      <div id="tab-saatler" class="tab-content hidden">
        <div class="admin-section">
          <h4>Saat Yönetimi</h4>
          <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="yeniSaatInp" placeholder="Örn: 07:00–15:00" style="padding:10px; border-radius:8px; border:1px solid var(--border);">
            <button onclick="saatEkle()" class="btn-main-action">SAAT EKLE</button>
          </div>
          <div id="saatListesiAdmin" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px;"></div>
        </div>
      </div>

      <div id="tab-kapasite" class="tab-content hidden">
        <div class="admin-section">
          <h4>Birim Kapasiteleri</h4>
          <div id="kapasiteTable" class="cap-grid-container"></div>
        </div>
      </div>

      <div id="tab-sistem" class="tab-content hidden">
        <div class="admin-section">
          <button onclick="vardiyaSifirla()" class="btn-main-action" style="background:var(--warning)">Sadece Atamaları Sıfırla</button>
          <button onclick="tamSifirla()" class="btn-main-action" style="background:var(--danger); margin-left:15px;">Fabrika Ayarlarına Dön (Tüm Verileri Sil)</button>
        </div>
      </div>
    </div>

    <main>
      <table id="vardiyaTablosu">
        <thead id="tableHeader"></thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
      </table>
    </main>
  </div>

  <script>
    const DEFAULT_UNITS = ["TEKNİK YÖNETMEN", "SES OPERATÖRÜ", "PLAYOUT OPERATÖRÜ", "KJ OPERATÖRÜ", "INGEST OPERATÖRÜ", "BİLGİ İŞLEM", "YAYIN SİSTEMLERİ", "24TV MCR OPERATÖRÜ", "360TV MCR OPERATÖRÜ"];
    const DEFAULT_SHIFTS = ["06:30–16:00", "09:00–18:00", "12:00–22:00", "16:00–00:00", "00:00–07:00", "DIŞ YAYIN"];
    const MCR_CYCLE = ["06:30–16:00", "06:30–16:00", "16:00–00:00", "16:00–00:00", "00:00–07:00", "00:00–07:00", "İZİNLİ", "İZİNLİ"];
    const GUNLER_TAM = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"];

    let state = {
        birimler: JSON.parse(localStorage.getItem("v66_birimler")) || DEFAULT_UNITS,
        saatler: JSON.parse(localStorage.getItem("v66_saatler")) || DEFAULT_SHIFTS,
        personeller: JSON.parse(localStorage.getItem("v66_personeller")) || [],
        kapasite: JSON.parse(localStorage.getItem("v66_kapasite")) || {},
        manuelAtamalar: JSON.parse(localStorage.getItem("v66_manuelAtamalar")) || {},
        gecmisCalisma: JSON.parse(localStorage.getItem("v66_gecmisCalisma")) || {}
    };

    let currentMonday = getMonday(new Date());
    function getMonday(d) { d = new Date(d); let day = d.getDay(); return new Date(d.setDate(d.getDate() - day + (day == 0 ? -6 : 1))); }
    function save() { Object.keys(state).forEach(k => localStorage.setItem(`v66_${k}`, JSON.stringify(state[k]))); }

    function tabloyuOlustur() {
        const hKey = currentMonday.toISOString().split('T')[0];
        const gecenHaftaKey = new Date(currentMonday.getTime() - 7*86400000).toISOString().split('T')[0];
        document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} - ${new Date(currentMonday.getTime() + 6*86400000).toLocaleDateString('tr-TR')}`;
        
        document.getElementById("tableHeader").innerHTML = `<tr><th style="width:150px">VARDİYA</th>${GUNLER_TAM.map((g,i) => `<th class="${i>=5?'weekend-col':''}">${g}</th>`).join('')}</tr>`;

        let prog = {}; let calis = {};
        state.personeller.forEach(p => { prog[p.ad] = Array(7).fill(null); calis[p.ad] = 0; });

        // Sabit İzinler
        state.personeller.forEach(p => { if(p.izinGunleri) p.izinGunleri.forEach(gi => { prog[p.ad][gi] = "İZİNLİ"; }); });

        // Manuel Müdahaleler
        state.personeller.forEach(p => {
            for (let i = 0; i < 7; i++) {
                let key = `${hKey}_${p.ad}_${i}`;
                if (state.manuelAtamalar[key]) {
                    prog[p.ad][i] = state.manuelAtamalar[key];
                    if (!["İZİNLİ", "OFF", "BOŞ"].includes(state.manuelAtamalar[key])) calis[p.ad]++;
                }
            }
        });

        // MCR Otomasyonu
        state.personeller.filter(p => p.birim.includes("MCR")).forEach((p, idx) => {
            for (let i = 0; i < 7; i++) { if(!prog[p.ad][i]) {
                let d = new Date(currentMonday); d.setDate(d.getDate() + i);
                let fark = Math.floor((d - new Date("2026-01-01")) / 86400000);
                prog[p.ad][i] = MCR_CYCLE[(fark + idx * 2) % 8];
            }}
        });

        // Diğer Atamalar
        for (let gun = 0; gun < 7; gun++) {
            state.birimler.filter(b => !b.includes("MCR")).forEach(birim => {
                state.saatler.forEach(saat => {
                    const cap = state.kapasite[`${birim}_${saat}`] || {h:0, hs:0};
                    let hedef = (gun >= 5) ? cap.hs : cap.h;
                    let mevcut = state.personeller.filter(p => p.birim === birim && prog[p.ad][gun] === saat).length;
                    
                    if (mevcut < hedef) {
                        let adaylar = state.personeller.filter(p => {
                            if (p.birim !== birim || prog[p.ad][gun] !== null) return false;
                            let gecenHaftaGun = state.gecmisCalisma[`${gecenHaftaKey}_${p.ad}`] || 5;
                            if (calis[p.ad] >= (gecenHaftaGun >= 6 ? 5 : 6)) return false; 
                            if (gun > 0 && prog[p.ad][gun-1] === "00:00–07:00" && saat.includes("06:30")) return false; 
                            if (birim === "TEKNİK YÖNETMEN" && saat.includes("00:00")) return false; 
                            return true;
                        }).sort((a,b) => (calis[a.ad] - calis[b.ad]) || Math.random() - 0.5);

                        for (let j = 0; j < (hedef - mevcut) && adaylar[j]; j++) { 
                            prog[adaylar[j].ad][gun] = saat; 
                            calis[adaylar[j].ad]++; 
                        }
                    }
                });
            });
        }
        state.personeller.forEach(p => { state.gecmisCalisma[`${hKey}_${p.ad}`] = calis[p.ad]; });
        save(); render(prog, calis);
    }

    function render(prog, calis) {
        document.getElementById("tableBody").innerHTML = state.saatler.map(s => `
            <tr><td style="background:#fcfcfc; font-weight:700; color:var(--primary)">${s}</td>
                ${[0,1,2,3,4,5,6].map(g => `<td class="${g>=5?'weekend-col':''}">${state.personeller.filter(p => prog[p.ad][g] === s).map(p => `
                    <div class="birim-card ${p.birim.includes('MCR')?'mcr-card':''}" onclick="vardiyaDegistir('${p.ad}',${g})">
                        <span class="birim-tag">${p.birim}</span><span class="pers-name">${p.ad}</span>
                    </div>`).join('')}</td>`).join('')}
            </tr>`).join('');
        
        document.getElementById("tableFooter").innerHTML = `<tr><td style="background:#f1f5f9; font-weight:700;">İZİNLİ / BOŞ</td>${[0,1,2,3,4,5,6].map(g => `<td class="${g>=5?'weekend-col':''}">${state.personeller.filter(p => ["İZİNLİ", "OFF", null].includes(prog[p.ad][g])).map(p => `
            <div class="birim-card ${prog[p.ad][g]?'izinli-card':''}" onclick="vardiyaDegistir('${p.ad}',${g})">
                <span class="birim-tag">${p.birim}</span><span class="pers-name">${p.ad}</span><br><small style="color:#64748b">${calis[p.ad]} GÜN</small>
            </div>`).join('')}</td>`).join('')}</tr>`;
    }

    function refreshUI() {
        document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => `<option value="${b}">${b}</option>`).join('');
        document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => `
            <div class="list-item" style="display:flex; justify-content:space-between; align-items:center; background:white; padding:12px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px;">
                <div><strong style="font-size:13px">${p.ad}</strong> <span style="color:#64748b; margin-left:10px;">[${p.birim}]</span><br>
                ${GUNLER_TAM.map((g, gi) => `<span class="izin-gun-pill ${p.izinGunleri?.includes(gi)?'active':''}" onclick="izinGunuTetikle(${i}, ${gi})">${g.substring(0,3)}</span>`).join('')}</div>
                <button onclick="state.personeller.splice(${i},1);save();refreshUI()" style="background:none; border:none; color:var(--danger); font-size:20px; cursor:pointer;">&times;</button>
            </div>`).join('');
        document.getElementById("saatListesiAdmin").innerHTML = state.saatler.map((s, i) => `
            <div class="list-item" style="background:white; padding:10px; border-radius:8px; border:1px solid var(--border); display:flex; justify-content:space-between;">${s} <button onclick="state.saatler.splice(${i},1);save();refreshUI();tabloyuOlustur()" style="border:none; color:var(--danger); background:none; cursor:pointer; font-weight:bold;">SİL</button></div>`).join('');
        kapasiteCiz();
    }

    function izinGunuTetikle(pIdx, gIdx) {
        if(!state.personeller[pIdx].izinGunleri) state.personeller[pIdx].izinGunleri = [];
        const index = state.personeller[pIdx].izinGunleri.indexOf(gIdx);
        if(index > -1) state.personeller[pIdx].izinGunleri.splice(index, 1);
        else state.personeller[pIdx].izinGunleri.push(gIdx);
        save(); refreshUI(); tabloyuOlustur();
    }

    function kapasiteCiz() {
        let html = `<div class="cap-row cap-header-row"><div class="cap-cell">BİRİM</div>${state.saatler.map(s => `<div class="cap-cell">${s}</div>`).join('')}</div>`;
        state.birimler.forEach(b => {
            html += `<div class="cap-row"><div class="cap-cell"><strong>${b}</strong></div>${state.saatler.map(s => {
                const v = state.kapasite[`${b}_${s}`] || {h:0, hs:0};
                return `<div class="cap-cell">
                    <div class="cap-input-group"><label>H-İÇİ:</label><input type="number" value="${v.h}" onchange="capUp('${b}_${s}','h',this.value)"></div>
                    <div class="cap-input-group weekend"><label>H-SONU:</label><input type="number" value="${v.hs}" onchange="capUp('${b}_${s}','hs',this.value)"></div>
                </div>`;
            }).join('')}</div>`;
        });
        document.getElementById("kapasiteTable").innerHTML = html;
    }

    function vardiyaDegistir(p, g) {
        const s = prompt(`${p} için Vardiya No (1-${state.saatler.length}), İZİN veya BOŞ:`);
        if (s) {
            let val = s.toUpperCase();
            if (!isNaN(s) && state.saatler[parseInt(s)-1]) val = state.saatler[parseInt(s)-1];
            else if (val === "BOŞ") val = null;
            else if (val === "İZİN") val = "İZİNLİ";
            state.manuelAtamalar[`${currentMonday.toISOString().split('T')[0]}_${p}_${g}`] = val;
            save(); tabloyuOlustur();
        }
    }

    function capUp(k, t, v) { state.kapasite[k] = state.kapasite[k] || {h:0, hs:0}; state.kapasite[k][t] = parseInt(v) || 0; save(); }
    function tabDegistir(t) { document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); }
    function toggleAdminPanel() { document.getElementById("adminPanel").classList.toggle("hidden"); refreshUI(); }
    function haftaDegistir(v) { currentMonday.setDate(currentMonday.getDate() + v); tabloyuOlustur(); }
    function saatEkle() { const v = document.getElementById("yeniSaatInp").value; if(v){state.saatler.push(v); save(); refreshUI(); tabloyuOlustur();} }
    function personelEkle() { const ad = document.getElementById("yeniPersInp").value.toUpperCase(); const b = document.getElementById("yeniPersBirimSec").value; if(ad){state.personeller.push({ad, birim: b, izinGunleri: []}); save(); refreshUI(); tabloyuOlustur();} }
    function vardiyaSifirla() { if(confirm("Atamalar silinecek?")) { state.manuelAtamalar = {}; save(); tabloyuOlustur(); } }
    function tamSifirla() { if(confirm("Tüm sistem sıfırlanacak!")) { localStorage.clear(); location.reload(); } }
    
    window.onload = () => { tabloyuOlustur(); refreshUI(); };
  </script>
</body>
</html>