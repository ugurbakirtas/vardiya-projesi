<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teknik Vardiya Planlama v102</title>
    <style>
        /* ESKİ KOYU TEMA VE GÖRSEL TASARIM */
        :root { --dark-bg: #111827; --panel-bg: #1f2937; --text-light: #f3f4f6; --accent-blue: #3b82f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--dark-bg); color: var(--text-light); margin: 0; font-size: 11px; }
        
        .header { background: var(--panel-bg); padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #374151; }
        .header h1 { margin: 0; font-size: 24px; color: white; letter-spacing: 1px; }

        /* MENÜ VE BUTONLAR */
        .nav-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; }
        .btn-blue { background: var(--accent-blue); }
        .btn-gray { background: #4b5563; }
        .btn-create { background: #2563eb; padding: 10px 30px; font-size: 14px; box-shadow: 0 4px 10px rgba(37,99,235,0.3); }

        /* TABLO TASARIMI */
        .container { padding: 20px; }
        table { width: 100%; border-collapse: separate; border-spacing: 2px; background: transparent; }
        th { background: #374151; color: #9ca3af; padding: 12px; text-transform: uppercase; font-size: 10px; border-radius: 4px; }
        td { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); height: 100px; vertical-align: top; border-radius: 4px; padding: 5px; }
        .shift-col { background: #1f2937 !important; font-weight: bold; text-align: center; width: 100px; vertical-align: middle; color: #60a5fa; }
        .weekend { background: rgba(255,255,255,0.08) !important; }

        /* KARTLAR */
        .birim-card { background: #111827; border: 1px solid #374151; border-left: 4px solid #ccc; padding: 8px; margin-bottom: 5px; border-radius: 4px; cursor: grab; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .birim-card b { display: block; font-size: 9px; margin-bottom: 2px; }

        /* YÖNETİM PANELİ (MODAL) */
        #adminPanel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .panel-content { background: var(--panel-bg); width: 95%; max-width: 1100px; height: 85vh; border-radius: 12px; border: 1px solid #4b5563; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { display: flex; background: #111827; border-bottom: 1px solid #374151; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: white; background: var(--accent-blue); }
        .tab-content { padding: 25px; overflow-y: auto; flex: 1; }

        .hidden { display: none !important; }
        input[type="number"] { background: #111827; border: 1px solid #4b5563; color: white; padding: 5px; border-radius: 4px; width: 40px; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1>TEKNİK VARDİYA</h1>
        <div id="tarihAraligi" style="color:#9ca3af; margin-top:5px;">Yükleniyor...</div>
    </div>
    <div class="nav-buttons">
        <button class="btn btn-gray" onclick="haftaDegistir(-1)">« GERİ</button>
        <button class="btn btn-blue btn-create" onclick="vardiyaOlustur()">VARDİYA OLUŞTUR</button>
        <button class="btn btn-gray" onclick="haftaDegistir(1)">İLERİ »</button>
        <button class="btn btn-gray" onclick="toggleAdminPanel()">⚙ YÖNETİM</button>
    </div>
</div>

<div class="container">
    <table>
        <thead>
            <tr>
                <th>SAAT</th><th>PAZARTESİ</th><th>SALI</th><th>ÇARŞAMBA</th><th>PERŞEMBE</th><th>CUMA</th><th class="weekend">CUMARTESİ</th><th class="weekend">PAZAR</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div id="adminPanel" class="hidden">
    <div class="panel-content">
        <div class="panel-header">
            <button class="tab-btn active" onclick="tabDegistir('personel')">PERSONEL/BİRİM</button>
            <button class="tab-btn" onclick="tabDegistir('kapasite')">SAAT/KAPASİTE</button>
            <button class="tab-btn" onclick="tabDegistir('sabit')">SABİT ATAMA</button>
            <button class="tab-btn" onclick="tabDegistir('sistem')">SİSTEM</button>
            <button class="tab-btn" style="background:#ef4444; color:white; max-width:80px;" onclick="toggleAdminPanel()">KAPAT</button>
        </div>

        <div id="tab-personel" class="tab-content">
            <h3 style="color:var(--accent-blue)">Personel Yönetimi</h3>
            <div id="personelList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px;"></div>
        </div>

        <div id="tab-kapasite" class="tab-content hidden">
            <h3 style="color:var(--accent-blue)">Vardiya Kapasite Sayıları</h3>
            <div id="kapasiteGrid"></div>
        </div>

        <div id="tab-sabit" class="tab-content hidden">
            <h3 style="color:var(--accent-blue)">Sabit Vardiya Atamaları</h3>
            <p>Burada belirlenen kişiler "Vardiya Oluştur" denildiğinde hep aynı saatte kalır.</p>
            <div id="sabitAtamaList"></div>
        </div>

        <div id="tab-sistem" class="tab-content hidden">
            <h3 style="color:var(--accent-blue)">Sistem Bakımı</h3>
            <button class="btn btn-gray" style="background:#dc2626;" onclick="sifirla()">TÜM VERİLERİ TEMİZLE</button>
        </div>
    </div>
</div>

<script>
// --- VERİ VE HAFIZA ---
const INITIAL_STAFF = [
    {ad: "CAN ŞENTUNALI", birim: "TEKNİK YÖNETMEN", id: 101}, {ad: "M.BERKMAN", birim: "TEKNİK YÖNETMEN", id: 102}, {ad: "EKREM FİDAN", birim: "TEKNİK YÖNETMEN", id: 103},
    {ad: "YUNUS EMRE YAYLA", birim: "TEKNİK YÖNETMEN", id: 104}, {ad: "H.CAN SAĞLAM", birim: "TEKNİK YÖNETMEN", id: 105}, {ad: "BARIŞ İNCE", birim: "TEKNİK YÖNETMEN", id: 106},
    {ad: "ANIL RİŞVAN", birim: "SES OPERATÖRÜ", id: 107}, {ad: "ULVİ MUTLUBAŞ", birim: "SES OPERATÖRÜ", id: 108}, {ad: "ZAFER AKAR", birim: "SES OPERATÖRÜ", id: 109},
    {ad: "ERDOĞAN KÜÇÜKKAYA", birim: "SES OPERATÖRÜ", id: 110}, {ad: "OSMAN DİNÇER", birim: "SES OPERATÖRÜ", id: 111}, {ad: "DOĞUŞ MALGIL", birim: "SES OPERATÖRÜ", id: 112},
    {ad: "ENES KALE", birim: "SES OPERATÖRÜ", id: 113}, {ad: "ERSAN TİLBE", birim: "SES OPERATÖRÜ", id: 114}, {ad: "NEHİR KAYGUSUZ", birim: "PLAYOUT OPERATÖRÜ", id: 115},
    {ad: "KADİR ÇAÇAN", birim: "PLAYOUT OPERATÖRÜ", id: 116}, {ad: "M.ERCÜMENT KILIÇ", birim: "PLAYOUT OPERATÖRÜ", id: 117}, {ad: "İBRAHİM SERİNSÖZ", birim: "PLAYOUT OPERATÖRÜ", id: 118},
    {ad: "YUSUF ALPKILIÇ", birim: "PLAYOUT OPERATÖRÜ", id: 119}, {ad: "SENA MİNARECİ", birim: "PLAYOUT OPERATÖRÜ", id: 120}, {ad: "MEHMET TUNÇ", birim: "PLAYOUT OPERATÖRÜ", id: 121},
    {ad: "YUSUF İSLAM TORUN", birim: "KJ OPERATÖRÜ", id: 122}, {ad: "CEMREHAN SUBAŞI", birim: "KJ OPERATÖRÜ", id: 123}, {ad: "DEMET CENGİZ", birim: "KJ OPERATÖRÜ", id: 124},
    {ad: "SENA BAYDAR", birim: "KJ OPERATÖRÜ", id: 125}, {ad: "OĞUZHAN YALAZAN", birim: "KJ OPERATÖRÜ", id: 126}, {ad: "YEŞİM KİREÇ", birim: "KJ OPERATÖRÜ", id: 127},
    {ad: "PINAR ÖZENÇ", birim: "KJ OPERATÖRÜ", id: 128}, {ad: "ERCAN PALABIYIK", birim: "INGEST OPERATÖRÜ", id: 129}, {ad: "RAMAZAN KOÇAK", birim: "INGEST OPERATÖRÜ", id: 130},
    {ad: "UĞUR AKBABA", birim: "INGEST OPERATÖRÜ", id: 131}, {ad: "ÖZKAN KAYA", birim: "BİLGİ İŞLEM", id: 132}, {ad: "HAKAN ELİPEK", birim: "BİLGİ İŞLEM", id: 133},
    {ad: "VOLKAN DEMİRBAŞ", birim: "BİLGİ İŞLEM", id: 134}, {ad: "GÖKHAN BAĞIŞ", birim: "BİLGİ İŞLEM", id: 135}, {ad: "FATİH AYBEK", birim: "YAYIN SİSTEMLERİ", id: 136},
    {ad: "AKİF KOÇ", birim: "YAYIN SİSTEMLERİ", id: 137}, {ad: "BEYHAN KARAKAŞ", birim: "YAYIN SİSTEMLERİ", id: 138}, {ad: "FERDİ TOPUZ", birim: "YAYIN SİSTEMLERİ", id: 139},
    {ad: "YİĞİT DAYI", birim: "YAYIN SİSTEMLERİ", id: 140}, {ad: "FARUK YILMAZ", birim: "24TV MCR OPERATÖRÜ", id: 141}, {ad: "KADİR YILMAZ", birim: "24TV MCR OPERATÖRÜ", id: 142},
    {ad: "YUSUF HENEK", birim: "24TV MCR OPERATÖRÜ", id: 143}, {ad: "SEDA KAYA", birim: "24TV MCR OPERATÖRÜ", id: 144}, {ad: "BÜKRE YAVUZ", birim: "360TV MCR OPERATÖRÜ", id: 145},
    {ad: "EMRULLAH AHLATÇI", birim: "360TV MCR OPERATÖRÜ", id: 146}, {ad: "EREN KAZAN", birim: "360TV MCR OPERATÖRÜ", id: 147}, {ad: "MUSAB YAKUP DEMİRBAŞ", birim: "360TV MCR OPERATÖRÜ", id: 148}
];

const SHIFTS = ["06:30–16:00", "09:00–18:00", "12:00–22:00", "16:00–00:00", "00:00–07:00", "DIŞ YAYIN"];
const UNIT_COLORS = { "TEKNİK YÖNETMEN": "#e74c3c", "SES OPERATÖRÜ": "#3498db", "PLAYOUT OPERATÖRÜ": "#2ecc71", "KJ OPERATÖRÜ": "#f1c40f", "INGEST OPERATÖRÜ": "#9b59b6", "BİLGİ İŞLEM": "#34495e", "YAYIN SİSTEMLERİ": "#1abc9c", "24TV MCR OPERATÖRÜ": "#e67e22", "360TV MCR OPERATÖRÜ": "#d35400" };

let state = {
    pers: JSON.parse(localStorage.getItem("vV_pers")) || INITIAL_STAFF,
    cap: JSON.parse(localStorage.getItem("vV_cap")) || {},
    man: JSON.parse(localStorage.getItem("vV_man")) || {}
};

let currentMonday = getMonday(new Date());

function getMonday(d) { d = new Date(d); let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); return new Date(d.setDate(diff)); }
function save() { localStorage.setItem("vV_pers", JSON.stringify(state.pers)); localStorage.setItem("vV_cap", JSON.stringify(state.cap)); localStorage.setItem("vV_man", JSON.stringify(state.man)); }

// --- ANA TABLO OLUŞTURMA ---
function tabloyuOlustur() {
    const haftaKey = currentMonday.toISOString().split('T')[0];
    document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} Haftası`;
    const body = document.getElementById("tableBody");
    body.innerHTML = SHIFTS.map(s => `
        <tr>
            <td class="shift-col">${s}</td>
            ${[0,1,2,3,4,5,6].map(i => `
                <td class="${i>4?'weekend':''}" ondragover="event.preventDefault()" ondrop="handleDrop(event, '${s}', ${i})">
                    ${state.pers.filter(p => state.man[`${haftaKey}_${p.ad}_${i}`] === s).map(p => `
                        <div class="birim-card" draggable="true" ondragstart="handleDragStart(event, '${p.ad}', ${i})" onclick="manuelGiris('${p.ad}', ${i})" style="border-left-color:${UNIT_COLORS[p.birim]}">
                            <b style="color:${UNIT_COLORS[p.birim]}">${p.birim}</b>${p.ad}
                        </div>
                    `).join('')}
                </td>`).join('')}
        </tr>`).join('');
}

// --- OTOMATİK OLUŞTURMA MOTORU ---
function vardiyaOlustur() {
    const haftaKey = currentMonday.toISOString().split('T')[0];
    // Sadece bu haftayı temizle, manuel/sabit atamalar kalabilir ama şimdilik temiz başla
    Object.keys(state.man).forEach(k => { if(k.startsWith(haftaKey)) delete state.man[k]; });

    // Teknik Yönetmen Gece Rotasyonu
    for(let i=0; i<7; i++) {
        let sorumlular = ["BARIŞ İNCE", "EKREM FİDAN"];
        let p = (i < 2) ? sorumlular[0] : sorumlular[1];
        state.man[`${haftaKey}_${p}_${i}`] = "00:00–07:00";
    }

    // Kapasiteye Göre Dağıt
    Object.keys(UNIT_COLORS).forEach(birim => {
        let birimdekiler = state.pers.filter(p => p.birim === birim);
        for(let gun=0; gun<7; gun++) {
            SHIFTS.forEach(saat => {
                let hedef = state.cap[birim + '_' + saat] || 0;
                let atanan = birimdekiler.filter(p => state.man[`${haftaKey}_${p.ad}_${gun}`] === saat).length;
                while(atanan < hedef) {
                    let musait = birimdekiler.find(p => !state.man[`${haftaKey}_${p.ad}_${gun}`]);
                    if(!musait) break;
                    state.man[`${haftaKey}_${musait.ad}_${gun}`] = saat;
                    atanan++;
                }
            });
        }
    });
    save(); tabloyuOlustur(); alert("Vardiya kapasiteye göre oluşturuldu.");
}

// --- YÖNETİM PANELİ FONKSİYONLARI ---
function toggleAdminPanel() { document.getElementById("adminPanel").classList.toggle("hidden"); refreshPanels(); }
function tabDegistir(id) { 
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+id).classList.remove('hidden');
    event.currentTarget.classList.add('active');
}
function refreshPanels() {
    // Personel Listesi
    document.getElementById("personelList").innerHTML = state.pers.map(p => `<div style="padding:10px; background:#111827; border-radius:5px;"><b>${p.ad}</b><br><small>${p.birim}</small></div>`).join('');
    // Kapasite Grid
    let grid = document.getElementById("kapasiteGrid");
    grid.innerHTML = `<div style="display:grid; grid-template-columns: 160px repeat(6, 1fr); gap:5px; margin-bottom:10px; font-weight:bold;"><div>Birim</div>${SHIFTS.map(s=>`<div>${s.split('–')[0]}</div>`).join('')}</div>`;
    Object.keys(UNIT_COLORS).forEach(b => {
        grid.innerHTML += `<div style="display:grid; grid-template-columns: 160px repeat(6, 1fr); gap:5px; align-items:center; border-bottom:1px solid #374151; padding:5px;"><div>${b}</div>${SHIFTS.map(s => `<input type="number" value="${state.cap[b+'_'+s]||0}" onchange="state.cap['${b+'_'+s}']=parseInt(this.value);save()">`).join('')}</div>`;
    });
}

function haftaDegistir(v) { currentMonday.setDate(currentMonday.getDate() + (v*7)); tabloyuOlustur(); }
function manuelGiris(p, i) {
    let s = prompt(`${p} için vardiya saatini girin:`, state.man[`${currentMonday.toISOString().split('T')[0]}_${p}_${i}`] || "");
    if(s !== null) { 
        if(s === "") delete state.man[`${currentMonday.toISOString().split('T')[0]}_${p}_${i}`]; 
        else state.man[`${currentMonday.toISOString().split('T')[0]}_${p}_${i}`] = s; 
        save(); tabloyuOlustur(); 
    }
}
let draggedData = null;
function handleDragStart(e, pAd, gun) { draggedData = { pAd, gun }; }
function handleDrop(e, vardiya, gun) {
    e.preventDefault(); if (!draggedData) return;
    state.man[`${currentMonday.toISOString().split('T')[0]}_${draggedData.pAd}_${gun}`] = vardiya;
    save(); tabloyuOlustur();
}
function sifirla() { if(confirm("Tüm vardiyalar silinsin mi?")) { state.man = {}; save(); tabloyuOlustur(); } }

window.onload = () => tabloyuOlustur();
</script>
</body>
</html>