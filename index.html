<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PRO-Vardiya v2026 | Ä°zin YÃ¶netimi Destekli</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0f172a; --blue: #2563eb; --bg: #f8fafc; --card-bg: #ffffff;
      --text: #1e293b; --border: #e2e8f0; --danger: #ef4444; --success: #22c55e;
      --warning: #f59e0b; --weekend-bg: #fee2e2; --weekend-border: #fecaca; --mcr-color: #f39c12;
    }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; font-size: 11px; }
    .app-wrapper { padding: 20px; }

    /* Header */
    .main-header { display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 15px; }
    .btn-main-action { background: var(--blue); color: white; border: none; padding: 10px 18px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 11px; }
    
    /* Checklist Area */
    .checklist-title { font-weight: bold; margin-bottom: 8px; color: var(--primary); display: block; width: 100%; }
    #personelChecklist { 
        margin-bottom:15px; display:flex; flex-wrap:wrap; gap:10px; 
        background:#fff3f3; padding:15px; border-radius:8px; border:1px solid #fda4af; 
    }
    .check-item { 
        display: flex; align-items: center; gap: 5px; background: white; 
        padding: 5px 10px; border-radius: 5px; border: 1px solid var(--border);
        cursor: pointer; transition: 0.2s;
    }
    .check-item:hover { border-color: var(--danger); }
    .check-item input { cursor: pointer; }

    /* Admin Panel */
    .admin-panel { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .admin-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid var(--border); }
    .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; }
    .tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
    
    .admin-section { background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
    .input-row { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    input, select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; }

    /* Kapasite */
    .cap-grid-container { overflow-x: auto; background: white; border: 1px solid var(--border); border-radius: 8px; }
    .cap-row { display: grid; grid-template-columns: 160px repeat(auto-fill, minmax(95px, 1fr)); border-bottom: 1px solid var(--border); }
    .cap-header-row { background: var(--primary); color: white; font-weight: bold; }
    .cap-cell { padding: 8px; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 5px; }
    .weekend-box { background-color: var(--weekend-bg); border: 1px solid var(--weekend-border); padding: 4px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }
    .cap-cell input { width: 35px !important; text-align: center; }

    /* Tablo */
    table { width: 100%; border-collapse: collapse; background: var(--card-bg); }
    th { background: var(--primary); color: white; padding: 12px 8px; border: 1px solid #334155; }
    td { border: 1px solid var(--border); padding: 5px; vertical-align: top; width: 13%; height: 85px; }
    .birim-card { border-left: 4px solid var(--blue); padding: 5px; margin-bottom: 4px; background: rgba(37,99,235,0.05); font-weight: 600; cursor: pointer; border-radius: 3px; font-size: 10px; }
    .mcr-card { border-left-color: var(--mcr-color); background: rgba(243,156,18,0.05); }
    .izinli-card { border-left-color: var(--danger); background: #fff1f2; opacity: 0.7; color: var(--danger); }
    .birim-tag { font-size: 7px; text-transform: uppercase; display: block; color: #64748b; }

    .list-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 6px 10px; border-radius: 6px; margin-bottom: 4px; border: 1px solid var(--border); }
    .btn-del { color: var(--danger); border: none; background: none; cursor: pointer; font-weight: bold; }
    .hidden { display: none !important; }

    @media print {
      .no-print, .nav-controls, .admin-panel, #personelChecklist { display: none !important; }
      body { background: white; padding: 0; }
      .app-wrapper { padding: 0; }
      .main-header { background: white !important; color: black !important; box-shadow: none; border-radius: 0; }
      .main-header h1 span { color: black !important; }
      table { border: 2px solid black; }
      th { background: #eee !important; color: black !important; border: 1px solid black; }
      td { border: 1px solid black; height: auto; }
      .birim-card { border: 1px solid #ddd; background: transparent !important; }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <header class="main-header">
      <div><h1>TEKNÄ°K <span style="color:var(--blue)">VARDÄ°YA</span></h1><p id="tarihAraligi" style="margin:0; opacity:0.8;"></p></div>
      <div class="nav-controls no-print">
        <button onclick="haftaDegistir(-7)" class="btn-main-action" style="background:#475569">Â« Geri</button>
        <button onclick="tabloyuOlustur()" class="btn-main-action">VARDÄ°YA OLUÅžTUR</button>
        <button onclick="window.print()" class="btn-main-action" style="background:#6366f1">YAZDIR / PDF</button>
        <button onclick="haftaDegistir(7)" class="btn-main-action" style="background:#475569">Ä°leri Â»</button>
        <button onclick="whatsappKopyala()" class="btn-main-action" style="background:#22c55e">WP Kopyala</button>
        <button onclick="toggleAdminPanel()" class="btn-main-action" style="background:#1e293b">âš™ YÃ¶netim</button>
      </div>
    </header>

    <div id="personelChecklist" class="no-print">
        <span class="checklist-title">ðŸš¨ BU HAFTA Ä°ZÄ°NLÄ° / RAPORLU OLANLARI SEÃ‡Ä°N:</span>
        </div>

    <div id="adminPanel" class="admin-panel hidden no-print">
      <div class="admin-tabs">
        <button class="tab-btn active" onclick="tabDegistir('ekip')">EKÄ°P / BÄ°RÄ°M</button>
        <button class="tab-btn" onclick="tabDegistir('saatler')">SAATLER</button>
        <button class="tab-btn" onclick="tabDegistir('kapasite')">KAPASÄ°TE</button>
        <button class="tab-btn" onclick="tabDegistir('sistem')">SÄ°STEM</button>
      </div>

      <div id="tab-ekip" class="tab-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="admin-section">
            <h4>Birim Ekle</h4>
            <div class="input-row">
              <input type="text" id="yeniBirimInp" placeholder="Birim AdÄ±">
              <button onclick="birimEkle()" class="btn-main-action">EKLE</button>
            </div>
            <div id="birimListesiAdmin"></div>
          </div>
          <div class="admin-section">
            <h4>Personel Ekle</h4>
            <div class="input-row">
              <input type="text" id="yeniPersInp" placeholder="Ad Soyad">
              <select id="yeniPersBirimSec"></select>
              <button onclick="personelEkle()" class="btn-main-action" style="background:var(--success)">EKLE</button>
            </div>
            <div id="persListesiAdmin"></div>
          </div>
        </div>
      </div>

      <div id="tab-saatler" class="tab-content hidden">
        <div class="admin-section">
          <h4>Vardiya Saatleri</h4>
          <div class="input-row">
            <input type="text" id="yeniSaatInp" placeholder="Ã–rn: 06:30â€“16:00">
            <button onclick="saatEkle()" class="btn-main-action">EKLE</button>
          </div>
          <div id="saatListesiAdmin"></div>
        </div>
      </div>

      <div id="tab-kapasite" class="tab-content hidden">
        <div id="kapasiteTable" class="cap-grid-container"></div>
      </div>

      <div id="tab-sistem" class="tab-content hidden">
        <div class="admin-section" style="display: flex; gap: 20px;">
          <button onclick="vardiyaSifirla()" class="btn-main-action" style="background:var(--warning)">MANUEL ATAMALARI TEMÄ°ZLE</button>
          <button onclick="tamSifirla()" class="btn-main-action" style="background:var(--danger)">FABRÄ°KA AYARLARINA DÃ–N</button>
        </div>
      </div>
    </div>

    <main>
      <table id="vardiyaTablosu"><thead id="tableHeader"></thead><tbody id="tableBody"></tbody><tfoot id="tableFooter"></tfoot></table>
    </main>
  </div>

  <script>
    const DEFAULT_UNITS = ["TEKNÄ°K YÃ–NETMEN", "SES OPERATÃ–RÃœ", "PLAYOUT OPERATÃ–RÃœ", "KJ OPERATÃ–RÃœ", "INGEST OPERATÃ–RÃœ", "BÄ°LGÄ° Ä°ÅžLEM", "YAYIN SÄ°STEMLERÄ°", "24TV MCR OPERATÃ–RÃœ", "360TV MCR OPERATÃ–RÃœ"];
    const DEFAULT_SHIFTS = ["06:30â€“16:00", "09:00â€“18:00", "12:00â€“22:00", "16:00â€“00:00", "00:00â€“07:00", "DIÅž YAYIN"];
    const MCR_CYCLE = ["06:30â€“16:00", "06:30â€“16:00", "16:00â€“00:00", "16:00â€“00:00", "00:00â€“07:00", "00:00â€“07:00", "Ä°ZÄ°NLÄ°", "Ä°ZÄ°NLÄ°"];
    const REFERENCE_DATE = new Date("2026-01-01");

    let state = {
        birimler: JSON.parse(localStorage.getItem("v59_birimler")) || DEFAULT_UNITS,
        saatler: JSON.parse(localStorage.getItem("v59_saatler")) || DEFAULT_SHIFTS,
        personeller: JSON.parse(localStorage.getItem("v59_personeller")) || [],
        kapasite: JSON.parse(localStorage.getItem("v59_kapasite")) || {},
        manuelAtamalar: JSON.parse(localStorage.getItem("v59_manuelAtamalar")) || {},
        aktifIzinliler: JSON.parse(localStorage.getItem("v59_aktifIzinliler")) || []
    };

    let currentMonday = getMonday(new Date());
    function getMonday(d) { d = new Date(d); let day = d.getDay(); return new Date(d.setDate(d.getDate() - day + (day == 0 ? -6 : 1))); }
    function save() { Object.keys(state).forEach(k => localStorage.setItem(`v59_${k}`, JSON.stringify(state[k]))); }

    function tabloyuOlustur() {
        const hKey = currentMonday.toISOString().split('T')[0];
        document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} HaftasÄ±`;
        const gunler = ["Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma", "Cumartesi", "Pazar"];
        document.getElementById("tableHeader").innerHTML = `<tr><th>Saat</th>${gunler.map(g => `<th>${g}</th>`).join('')}</tr>`;

        let prog = {}; let calis = {};
        
        // Personel DurumlarÄ±nÄ± HazÄ±rla
        state.personeller.forEach(p => {
            prog[p.ad] = Array(7).fill(null);
            calis[p.ad] = 0;
            // EÄžER PERSONEL Ä°ZÄ°NLÄ° SEÃ‡Ä°LDÄ°YSE TÃœM HAFTAYI Ä°ZÄ°NLÄ° YAP
            if (state.aktifIzinliler.includes(p.ad)) {
                prog[p.ad].fill("Ä°ZÄ°NLÄ°");
            }
        });

        // 1. MCR DÃ¶ngÃ¼sÃ¼ (Ä°zinli deÄŸilse)
        state.personeller.filter(p => p.birim.includes("MCR")).forEach((p, idx) => {
            if (state.aktifIzinliler.includes(p.ad)) return;
            for (let i = 0; i < 7; i++) {
                let d = new Date(currentMonday); d.setDate(d.getDate() + i);
                let fark = Math.floor((d - REFERENCE_DATE) / 86400000);
                let cIdx = (fark + idx * 2) % 8; if(cIdx < 0) cIdx += 8;
                prog[p.ad][i] = MCR_CYCLE[cIdx];
            }
        });

        // 2. Teknik YÃ¶netmen Rotasyonu (Ä°zin KontrollÃ¼)
        for (let i = 0; i < 7; i++) {
            let adaylar = ["BARIÅž Ä°NCE", "EKREM FÄ°DAN"];
            let sor = (i < 2) ? "BARIÅž Ä°NCE" : "EKREM FÄ°DAN";
            
            // EÄŸer atanmasÄ± gereken kiÅŸi izinliyse diÄŸerini ata
            if (state.aktifIzinliler.includes(sor)) {
                sor = adaylar.find(a => a !== sor);
            }

            if (prog[sor] && !prog[sor][i] && !state.aktifIzinliler.includes(sor)) {
                prog[sor][i] = "00:00â€“07:00";
            }
        }

        // 3. Manuel Atamalar
        state.personeller.forEach(p => {
            for (let i = 0; i < 7; i++) {
                let key = `${hKey}_${p.ad}_${i}`;
                if (state.manuelAtamalar[key]) prog[p.ad][i] = state.manuelAtamalar[key];
                if (prog[p.ad][i] && !["Ä°ZÄ°NLÄ°", "BOÅž"].includes(prog[p.ad][i])) calis[p.ad]++;
            }
        });

        // 4. Otomatik Atama (Ä°zinli olmayanlar arasÄ±nda)
        for (let gun = 0; gun < 7; gun++) {
            state.birimler.filter(b => !b.includes("MCR")).forEach(birim => {
                state.saatler.forEach(saat => {
                    const cap = state.kapasite[`${birim}_${saat}`] || {h:0, hs:0};
                    let hedef = (gun >= 5) ? cap.hs : cap.h;
                    let mevcut = state.personeller.filter(p => p.birim === birim && prog[p.ad][gun] === saat).length;
                    
                    if (mevcut < hedef) {
                        let adaylar = state.personeller.filter(p => 
                            p.birim === birim && 
                            prog[p.ad][gun] === null && 
                            calis[p.ad] < 6 && 
                            !state.aktifIzinliler.includes(p.ad)
                        );
                        adaylar.sort((a,b) => calis[a.ad] - calis[b.ad]);
                        for (let j = 0; j < (hedef - mevcut) && adaylar[j]; j++) { 
                            prog[adaylar[j].ad][gun] = saat; 
                            calis[adaylar[j].ad]++; 
                        }
                    }
                });
            });
        }
        render(prog);
    }

    function render(prog) {
        document.getElementById("tableBody").innerHTML = state.saatler.map(s => `
            <tr><td><strong>${s}</strong></td>
                ${[0,1,2,3,4,5,6].map(g => `<td>${state.personeller.filter(p => prog[p.ad][g] === s).map(p => `
                    <div class="birim-card ${p.birim.includes('MCR')?'mcr-card':''}" onclick="vardiyaDegistir('${p.ad}',${g})">
                        <span class="birim-tag">${p.birim}</span>${p.ad}
                    </div>`).join('')}</td>`).join('')}
            </tr>`).join('');
        document.getElementById("tableFooter").innerHTML = `<tr><td><strong>Ä°ZÄ°NLÄ° / DÄ°ÄžER</strong></td>${[0,1,2,3,4,5,6].map(g => `<td>${state.personeller.filter(p => prog[p.ad][g] === "Ä°ZÄ°NLÄ°" || prog[p.ad][g] === null).map(p => `
            <div class="birim-card ${state.aktifIzinliler.includes(p.ad)?'izinli-card':''}" style="opacity:0.6" onclick="vardiyaDegistir('${p.ad}',${g})">
                <span class="birim-tag">${p.birim}</span>${p.ad} ${state.aktifIzinliler.includes(p.ad)?'(Ä°ZÄ°NLÄ°)':''}
            </div>`).join('')}</td>`).join('')}</tr>`;
    }

    function refreshUI() {
        document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => `<option value="${b}">${b}</option>`).join('');
        document.getElementById("birimListesiAdmin").innerHTML = state.birimler.map((b, i) => `<div class="list-item">${b} <button onclick="state.birimler.splice(${i},1);save();refreshUI()" class="btn-del">Ã—</button></div>`).join('');
        document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => `<div class="list-item"><span>${p.ad} <small>(${p.birim})</small></span><button onclick="state.personeller.splice(${i},1);save();refreshUI()" class="btn-del">Ã—</button></div>`).join('');
        document.getElementById("saatListesiAdmin").innerHTML = state.saatler.map((s, i) => `<div class="list-item">${s} <button onclick="state.saatler.splice(${i},1);save();refreshUI()" class="btn-del">Ã—</button></div>`).join('');
        
        // Ãœst Ä°zin Checklist
        document.getElementById("personelChecklist").innerHTML = '<span class="checklist-title">ðŸš¨ BU HAFTA Ä°ZÄ°NLÄ° OLANLARI SEÃ‡Ä°N:</span>' + 
            state.personeller.map(p => `
            <label class="check-item">
                <input type="checkbox" value="${p.ad}" ${state.aktifIzinliler.includes(p.ad)?'checked':''} onchange="izinGuncelle(this)">
                ${p.ad}
            </label>`).join('');
        
        kapasiteCiz();
    }

    function izinGuncelle(el) {
        if (el.checked) {
            if (!state.aktifIzinliler.includes(el.value)) state.aktifIzinliler.push(el.value);
        } else {
            state.aktifIzinliler = state.aktifIzinliler.filter(name => name !== el.value);
        }
        save();
        tabloyuOlustur();
    }

    function vardiyaSifirla() { if(confirm("Manuel atamalar silinsin mi?")) { state.manuelAtamalar = {}; save(); tabloyuOlustur(); } }
    function tamSifirla() { if(confirm("Her ÅŸey silinsin mi?")) { localStorage.clear(); location.reload(); } }
    function birimEkle() { const v = document.getElementById("yeniBirimInp").value.toUpperCase(); if(v){state.birimler.push(v); save(); refreshUI(); document.getElementById("yeniBirimInp").value="";} }
    function personelEkle() { const ad = document.getElementById("yeniPersInp").value.toUpperCase(); const b = document.getElementById("yeniPersBirimSec").value; if(ad){state.personeller.push({ad, birim: b, id: Date.now()}); save(); refreshUI(); tabloyuOlustur();} }
    function saatEkle() { const v = document.getElementById("yeniSaatInp").value; if(v){state.saatler.push(v); save(); refreshUI(); tabloyuOlustur();} }
    
    function kapasiteCiz() {
        let html = `<div class="cap-row cap-header-row"><div class="cap-cell">Birim / Saat</div>${state.saatler.map(s => `<div class="cap-cell">${s.split('â€“')[0]}</div>`).join('')}</div>`;
        state.birimler.forEach(b => {
            html += `<div class="cap-row"><div class="cap-cell"><strong>${b}</strong></div>${state.saatler.map(s => {
                const v = state.kapasite[`${b}_${s}`] || {h:0, hs:0};
                return `<div class="cap-cell"><div class="weekday-box">H:<input type="number" value="${v.h}" onchange="capUp('${b}_${s}','h',this.value)"></div><div class="weekend-box">S:<input type="number" value="${v.hs}" onchange="capUp('${b}_${s}','hs',this.value)"></div></div>`;
            }).join('')}</div>`;
        });
        document.getElementById("kapasiteTable").innerHTML = html;
    }

    function capUp(k, t, v) { state.kapasite[k] = state.kapasite[k] || {h:0, hs:0}; state.kapasite[k][t] = parseInt(v) || 0; save(); }
    function tabDegistir(t) { document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); }
    function toggleAdminPanel() { document.getElementById("adminPanel").classList.toggle("hidden"); refreshUI(); }
    function vardiyaDegistir(p, g) { const s = prompt(`${p} vardiya no veya Ä°ZÄ°NLÄ°`); if(s){ state.manuelAtamalar[`${currentMonday.toISOString().split('T')[0]}_${p}_${g}`] = isNaN(s)?s.toUpperCase():state.saatler[s-1]; save(); tabloyuOlustur(); } }
    function haftaDegistir(v) { currentMonday.setDate(currentMonday.getDate() + v); tabloyuOlustur(); }
    function whatsappKopyala() { let t = `ðŸ“… *${currentMonday.toLocaleDateString()} HAFTALIK VARDÄ°YA*\n\n`; document.querySelectorAll("#vardiyaTablosu tr").forEach(r => { const c = r.querySelectorAll("td, th"); if(c.length) t += `*${c[0].innerText}* âž” ${Array.from(c).slice(1).map(x => x.innerText.replace(/\n/g, ", ").trim()).join(" | ")}\n`; }); navigator.clipboard.writeText(t).then(() => alert("KopyalandÄ±!")); }
    window.onload = () => { tabloyuOlustur(); refreshUI(); };
  </script>
</body>
</html>