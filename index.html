<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PRO-Vardiya v2026 | Teknik YÃ¶netim</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0f172a;
      --blue: #2563eb;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
      --danger: #ef4444;
      --success: #22c55e;
      --weekend-bg: #fee2e2;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      font-size: 11px;
    }

    .app-wrapper { padding: 20px; }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary);
      color: white;
      padding: 15px 25px;
      border-radius: 12px;
      margin-bottom: 15px;
    }

    .btn-main-action {
      background: var(--blue);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn-main-action:hover { opacity: 0.9; transform: translateY(-1px); }

    .admin-panel {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }

    .tab-btn {
      padding: 8px 16px;
      cursor: pointer;
      border: none;
      background: none;
      border-radius: 6px;
      font-weight: 600;
      color: #64748b;
    }

    .tab-btn.active { background: var(--blue); color: white; }

    .admin-section-box {
      background: #f1f5f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .admin-input-group { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    input, select {
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
    }

    th {
      background: var(--primary);
      color: white;
      padding: 12px 8px;
      border: 1px solid #334155;
    }

    td {
      border: 1px solid var(--border);
      padding: 6px;
      vertical-align: top;
      width: 13%;
    }

    .birim-card {
      border-left: 4px solid var(--blue);
      padding: 6px;
      margin-bottom: 4px;
      background: rgba(37,99,235,0.05);
      font-weight: 600;
      cursor: pointer;
      border-radius: 2px;
    }

    .birim-tag { font-size: 7px; text-transform: uppercase; display: block; margin-bottom: 2px; opacity: 0.8; }

    /* Kapasite Grid */
    .cap-grid-container { overflow-x: auto; }
    .cap-row {
      display: grid;
      grid-template-columns: 180px repeat(auto-fill, minmax(100px, 1fr));
      gap: 5px;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid var(--border);
    }
    .cap-header { background: var(--primary); color: white; font-weight: bold; }
    .cap-input-item { display: flex; flex-direction: column; font-size: 9px; gap: 2px; padding: 4px; border-radius: 4px; border: 1px solid transparent; }
    .weekend-input { background-color: var(--weekend-bg); border-color: #fecaca; }
    .cap-input-item input { width: 40px; padding: 2px; text-align: center; font-weight: bold; }

    .unit-item { display: inline-flex; align-items: center; background: var(--primary); color: white; padding: 5px 10px; border-radius: 20px; margin: 5px; font-size: 10px; }
    .btn-del { color: var(--danger); border: none; background: none; cursor: pointer; font-weight: bold; margin-left: 10px; }
    .pers-list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    .pers-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid var(--border); }

    .hidden { display: none !important; }

    @media print {
      .no-print { display: none !important; }
      .app-wrapper { padding: 0; }
      body { background: white; }
      .birim-card { border: 1px solid #eee; }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <header class="main-header no-print">
      <div>
        <h1 style="margin:0; font-size:18px;">TEKNÄ°K <span style="color:var(--blue)">VARDÄ°YA</span></h1>
        <p id="tarihAraligi" style="margin:0; opacity:0.8;"></p>
      </div>
      <div class="nav-controls">
        <button onclick="haftaDegistir(-7)" class="btn-main-action" style="background:#475569">Â« Geri</button>
        <button onclick="tabloyuOlustur()" class="btn-main-action">VARDÄ°YA OLUÅžTUR</button>
        <button onclick="haftaDegistir(7)" class="btn-main-action" style="background:#475569">Ä°leri Â»</button>
        <button onclick="window.print()" class="btn-main-action" style="background:#6366f1">ðŸ–¨ YazdÄ±r</button>
        <button onclick="whatsappKopyala()" class="btn-main-action" style="background:#22c55e">ðŸ“± WP Kopyala</button>
        <button onclick="toggleAdminPanel()" class="btn-main-action" style="background:#1e293b">âš™ YÃ¶netim</button>
      </div>
    </header>

    <div id="adminPanel" class="admin-panel hidden no-print">
      <div class="admin-tabs">
        <button class="tab-btn active" onclick="tabDegistir('ekip')">EKÄ°P VE BÄ°RÄ°MLER</button>
        <button class="tab-btn" onclick="tabDegistir('saatler')">VARDÄ°YA SAATLERÄ°</button>
        <button class="tab-btn" onclick="tabDegistir('kapasite')">KAPASÄ°TE AYARLARI</button>
        <button class="tab-btn" onclick="tabDegistir('sistem')">SÄ°STEM</button>
      </div>

      <div id="tab-ekip" class="tab-content">
        <div class="admin-section-box">
            <h4>Birim Ekleme</h4>
            <div class="admin-input-group">
                <input type="text" id="yeniBirimInp" placeholder="Birim AdÄ±">
                <button onclick="birimEkle()" class="btn-main-action" style="background:var(--primary)">EKLE</button>
            </div>
            <div id="birimListesiAdmin" style="margin-top:10px;"></div>
        </div>
        <div class="admin-section-box">
            <h4>Personel Ekleme</h4>
            <div class="admin-input-group">
                <input type="text" id="yeniPersInp" placeholder="Ad Soyad">
                <select id="yeniPersBirimSec"></select>
                <button onclick="personelEkle()" class="btn-main-action" style="background:var(--success)">EKLE</button>
            </div>
            <div id="persListesiAdmin" class="pers-list-grid" style="margin-top:15px;"></div>
        </div>
      </div>

      <div id="tab-saatler" class="tab-content hidden">
        <div class="admin-section-box">
            <h4>Vardiya Saatlerini YÃ¶net</h4>
            <div class="admin-input-group">
                <input type="text" id="yeniSaatInp" placeholder="Ã–rn: 08:00â€“17:00">
                <button onclick="saatEkle()" class="btn-main-action">SAAT EKLE</button>
            </div>
            <div id="saatListesiAdmin" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
        </div>
      </div>

      <div id="tab-kapasite" class="tab-content hidden">
        <div style="margin-bottom:15px; padding:10px; background:#e2e8f0; border-radius:6px;">
            <span style="font-weight:600;">H: Hafta Ä°Ã§i</span> | <span style="background:var(--weekend-bg); padding:2px 5px; border-radius:3px; font-weight:600; border:1px solid #fecaca;">S: Hafta Sonu</span>
        </div>
        <div id="kapasiteTable" class="cap-grid-container"></div>
      </div>

      <div id="tab-sistem" class="tab-content hidden">
        <button onclick="sifirla()" class="btn-main-action" style="background:var(--danger)">TÃœM VERÄ°LERÄ° TEMÄ°ZLE</button>
      </div>
    </div>

    <main>
      <div id="personelChecklist" class="no-print" style="margin-bottom:15px; background:white; padding:10px; border-radius:8px; display:flex; flex-wrap:wrap; gap:10px;"></div>
      <table id="vardiyaTablosu">
        <thead id="tableHeader"></thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
      </table>
    </main>
  </div>

  <script>
    const DEFAULT_UNITS = ["TEKNÄ°K YÃ–NETMEN", "SES OPERATÃ–RÃœ", "PLAYOUT OPERATÃ–RÃœ", "KJ OPERATÃ–RÃœ", "INGEST OPERATÃ–RÃœ", "BÄ°LGÄ° Ä°ÅžLEM", "YAYIN SÄ°STEMLERÄ°", "24TV MCR OPERATÃ–RÃœ", "360TV MCR OPERATÃ–RÃœ"];
    const DEFAULT_SHIFTS = ["06:30â€“16:00", "09:00â€“18:00", "12:00â€“22:00", "16:00â€“00:00", "00:00â€“07:00", "DIÅž YAYIN"];
    const UNIT_COLORS = { "TEKNÄ°K YÃ–NETMEN": "#e74c3c", "SES OPERATÃ–RÃœ": "#3498db", "PLAYOUT OPERATÃ–RÃœ": "#2ecc71", "KJ OPERATÃ–RÃœ": "#f1c40f", "24TV MCR OPERATÃ–RÃœ": "#e67e22", "360TV MCR OPERATÃ–RÃœ": "#d35400" };

    let state = {
        birimler: JSON.parse(localStorage.getItem("v50_birimler")) || DEFAULT_UNITS,
        saatler: JSON.parse(localStorage.getItem("v50_saatler")) || DEFAULT_SHIFTS,
        personeller: JSON.parse(localStorage.getItem("v50_personeller")) || [],
        kapasite: JSON.parse(localStorage.getItem("v50_kapasite")) || {},
        manuelAtamalar: JSON.parse(localStorage.getItem("v50_manuelAtamalar")) || {}
    };

    let currentMonday = getMonday(new Date());

    function getMonday(d) {
        d = new Date(d);
        let day = d.getDay();
        let diff = d.getDate() - day + (day == 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }

    function save() {
        Object.keys(state).forEach(k => localStorage.setItem(`v50_${k}`, JSON.stringify(state[k])));
    }

    function tabloyuOlustur() {
        const haftaKey = currentMonday.toISOString().split('T')[0];
        document.getElementById("tarihAraligi").innerText = `${currentMonday.toLocaleDateString('tr-TR')} HaftasÄ±`;
        
        const gunler = ["Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma", "Cumartesi", "Pazar"];
        document.getElementById("tableHeader").innerHTML = `<tr><th>Saat</th>${gunler.map(g => `<th>${g}</th>`).join('')}</tr>`;

        let program = {};
        let calismaSayisi = {};
        state.personeller.forEach(p => {
            program[p.ad] = Array(7).fill(null);
            calismaSayisi[p.ad] = 0;
            if (document.getElementById(`check_${p.id}`)?.checked) program[p.ad].fill("Ä°ZÄ°NLÄ°");
        });

        state.personeller.forEach(p => {
            for (let i = 0; i < 7; i++) {
                let mK = `${haftaKey}_${p.ad}_${i}`;
                if (state.manuelAtamalar[mK]) {
                    program[p.ad][i] = state.manuelAtamalar[mK];
                    if (!["Ä°ZÄ°NLÄ°", "BOÅžALT", "BOÅž"].includes(program[p.ad][i])) calismaSayisi[p.ad]++;
                }
            }
        });

        for (let i = 0; i < 7; i++) {
            let geceSorumlusu = (i < 2) ? "BARIÅž Ä°NCE" : "EKREM FÄ°DAN";
            if (program[geceSorumlusu] && program[geceSorumlusu][i] === null) {
                program[geceSorumlusu][i] = "00:00â€“07:00";
                calismaSayisi[geceSorumlusu]++;
            }
        }

        for (let gun = 0; gun < 7; gun++) {
            const isHs = gun >= 5;
            state.birimler.forEach(birim => {
                state.saatler.forEach(saat => {
                    const cap = state.kapasite[`${birim}_${saat}`] || {h:0, hs:0};
                    const hedef = isHs ? cap.hs : cap.h;
                    let mevcut = state.personeller.filter(p => p.birim === birim && program[p.ad][gun] === saat).length;
                    
                    if (mevcut < hedef) {
                        let adaylar = state.personeller.filter(p => p.birim === birim && program[p.ad][gun] === null && calismaSayisi[p.ad] < 6);
                        if (birim === "TEKNÄ°K YÃ–NETMEN" && saat === "00:00â€“07:00") {
                            adaylar = adaylar.filter(a => ["BARIÅž Ä°NCE", "EKREM FÄ°DAN"].includes(a.ad));
                        }
                        adaylar.sort((a, b) => calismaSayisi[a.ad] - calismaSayisi[b.ad]);
                        for (let j = 0; j < (hedef - mevcut) && adaylar[j]; j++) {
                            program[adaylar[j].ad][gun] = saat;
                            calismaSayisi[adaylar[j].ad]++;
                        }
                    }
                });
            });
        }
        render(program);
    }

    function render(program) {
        const body = document.getElementById("tableBody");
        body.innerHTML = state.saatler.map(saat => `
            <tr>
                <td><strong>${saat}</strong></td>
                ${[0,1,2,3,4,5,6].map(gun => `
                    <td>
                        ${state.personeller.filter(p => program[p.ad][gun] === saat).map(p => `
                            <div class="birim-card" onclick="vardiyaDegistir('${p.ad}',${gun})" style="border-left-color:${UNIT_COLORS[p.birim] || '#ccc'}">
                                <span class="birim-tag" style="color:${UNIT_COLORS[p.birim] || '#666'}">${p.birim}</span>
                                ${p.ad}
                            </div>
                        `).join('')}
                    </td>
                `).join('')}
            </tr>
        `).join('');

        const foot = document.getElementById("tableFooter");
        foot.innerHTML = `<tr class="izinli-satiri"><td><strong>BOÅž / Ä°ZÄ°NLÄ°</strong></td>
            ${[0,1,2,3,4,5,6].map(gun => `<td>
                ${state.personeller.filter(p => program[p.ad][gun] === null || program[p.ad][gun] === "Ä°ZÄ°NLÄ°").map(p => `
                    <div class="birim-card" style="opacity:0.6; border-left-color:#ccc" onclick="vardiyaDegistir('${p.ad}',${gun})">${p.ad}</div>
                `).join('')}
            </td>`).join('')}</tr>`;
    }

    function kapasiteCiz() {
        const box = document.getElementById("kapasiteTable");
        let header = `<div class="cap-row cap-header"><div>Birimler / Saatler</div>${state.saatler.map(s => `<div>${s.split('â€“')[0]}</div>`).join('')}</div>`;
        let rows = state.birimler.map(b => `
            <div class="cap-row">
                <div style="font-weight:700;">${b}</div>
                ${state.saatler.map(s => {
                    const v = state.kapasite[`${b}_${s}`] || {h:0, hs:0};
                    return `<div class="cap-input-item">
                                <span>H: <input type="number" value="${v.h}" onchange="capUp('${b}_${s}','h',this.value)"></span>
                                <span class="weekend-input">S: <input type="number" value="${v.hs}" onchange="capUp('${b}_${s}','hs',this.value)"></span>
                            </div>`;
                }).join('')}
            </div>`).join('');
        box.innerHTML = header + rows;
    }

    function whatsappKopyala() {
        const gunler = ["Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma", "Cumartesi", "Pazar"];
        let metin = `ðŸ“… *${currentMonday.toLocaleDateString('tr-TR')} HAFTALIK TEKNÄ°K VARDÄ°YA*\n\n`;
        
        gunler.forEach((gun, i) => {
            metin += `*${gun.toUpperCase()}*\n`;
            state.saatler.forEach(saat => {
                const kisiler = state.personeller.filter(p => {
                    const haftaKey = currentMonday.toISOString().split('T')[0];
                    const mK = `${haftaKey}_${p.ad}_${i}`;
                    // Bu kÄ±sÄ±m render mantÄ±ÄŸÄ±yla aynÄ± olmalÄ±, basitleÅŸtirmek iÃ§in DOM'dan Ã§ekilebilir
                    return false; // Ã–zetle basitleÅŸtirilmiÅŸ bir dÃ¶ngÃ¼ gerekir
                });
                // Not: KarmaÅŸÄ±k atama algoritmasÄ± nedeniyle bu metin oluÅŸturma render'dan beslenmeli
            });
            metin += `-------------------\n`;
        });
        
        // HÄ±zlÄ± Ã§Ã¶zÃ¼m: Tablodaki verileri metne dÃ¶k
        let tabloMetni = `ðŸ“… *${currentMonday.toLocaleDateString('tr-TR')} HAFTASI VARDÄ°YA LÄ°STESÄ°*\n\n`;
        const rows = document.querySelectorAll("#vardiyaTablosu tr");
        rows.forEach(row => {
            const cells = row.querySelectorAll("td, th");
            if(cells.length > 0) {
                tabloMetni += `*${cells[0].innerText}* âž” ${Array.from(cells).slice(1).map(c => c.innerText.replace(/\n/g, ", ")).join(" | ")}\n`;
            }
        });

        navigator.clipboard.writeText(tabloMetni).then(() => alert("Vardiya listesi WhatsApp iÃ§in kopyalandÄ±!"));
    }

    function capUp(k, t, v) { state.kapasite[k] = state.kapasite[k] || {h:0, hs:0}; state.kapasite[k][t] = parseInt(v) || 0; save(); }
    function toggleAdminPanel() { document.getElementById("adminPanel").classList.toggle("hidden"); refreshUI(); }
    function tabDegistir(t) { 
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }

    function refreshUI() {
        document.getElementById("yeniPersBirimSec").innerHTML = state.birimler.map(b => `<option value="${b}">${b}</option>`).join('');
        document.getElementById("birimListesiAdmin").innerHTML = state.birimler.map((b, i) => `<span class="unit-item">${b} <button onclick="birimSil(${i})" class="btn-del" style="color:white">Ã—</button></span>`).join('');
        document.getElementById("persListesiAdmin").innerHTML = state.personeller.map((p, i) => `<div class="pers-item"><span>${p.ad} <small>(${p.birim})</small></span><button onclick="persSil(${i})" class="btn-del">SÄ°L</button></div>`).join('');
        document.getElementById("saatListesiAdmin").innerHTML = state.saatler.map((s, i) => `<span class="unit-item" style="background:#475569">${s} <button onclick="saatSil(${i})" class="btn-del" style="color:white">Ã—</button></span>`).join('');
        checklistOlustur();
        kapasiteCiz();
    }

    function saatEkle() {
        const s = document.getElementById("yeniSaatInp").value.trim();
        if(s && !state.saatler.includes(s)) { state.saatler.push(s); save(); refreshUI(); tabloyuOlustur(); }
    }
    function saatSil(i) { if(confirm("Bu vardiya saatini silmek istediÄŸinize emin misiniz?")) { state.saatler.splice(i, 1); save(); refreshUI(); tabloyuOlustur(); } }
    function birimEkle() {
        const b = document.getElementById("yeniBirimInp").value.toUpperCase().trim();
        if(b && !state.birimler.includes(b)) { state.birimler.push(b); save(); refreshUI(); }
    }
    function birimSil(i) { if(confirm("Birim silinsin mi?")) { state.birimler.splice(i, 1); save(); refreshUI(); } }
    function personelEkle() {
        const ad = document.getElementById("yeniPersInp").value.toUpperCase().trim();
        const birim = document.getElementById("yeniPersBirimSec").value;
        if(ad) { state.personeller.push({ad, birim, id: Date.now()}); save(); document.getElementById("yeniPersInp").value = ""; refreshUI(); tabloyuOlustur(); }
    }
    function persSil(i) { if(confirm("Personel silinsin mi?")) { state.personeller.splice(i, 1); save(); refreshUI(); tabloyuOlustur(); } }
    function checklistOlustur() {
        document.getElementById("personelChecklist").innerHTML = state.personeller.map(p => `
            <label style="cursor:pointer; background:#f1f5f9; padding:5px 10px; border-radius:4px; font-size:10px;">
                <input type="checkbox" id="check_${p.id}" onchange="tabloyuOlustur()"> ${p.ad}
            </label>
        `).join('');
    }
    function haftaDegistir(v) { currentMonday.setDate(currentMonday.getDate() + v); tabloyuOlustur(); }
    function sifirla() { if(confirm("TÃœM VERÄ°LER SÄ°LÄ°NECEK!")) { localStorage.clear(); location.reload(); } }

    window.onload = () => { tabloyuOlustur(); refreshUI(); };
  </script>
</body>
</html>